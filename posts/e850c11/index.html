<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  
  <meta name="description" content="å¹³å¸¸å·¥ä½œä¸­ï¼Œå¤§å®¶æˆ–å¤šæˆ–å°‘éƒ½å¬è¿‡æˆ–è€…ä½¿ç”¨è¿‡ Unix Domain Socket, ä½†å¯èƒ½æ²¡æœ‰ç³»ç»Ÿçš„æ€»ç»“æ¢³ç†è¿‡ï¼Œæ¯”å¦‚ä¸ TCP/UDP Socket
å·®åˆ«åœ¨å“ªé‡Œï¼Œé™¤äº†æ™®é€šçš„æ•°æ®ä¼ é€’è¿˜æœ‰å“ªäº›ç©æ³•ï¼Œèƒ½å¦åˆ©ç”¨ tcpdump æŠ“å–æµé‡å‘¢? è¯¥æ–‡ç« ä¸»è¦ä»æ˜¯ä»€ä¹ˆã€æ€ä¹ˆç”¨ã€æ€§èƒ½å¦‚ä½•å’ŒæŠ“åŒ…æ’éšœç­‰è§’åº¦è¿›è¡Œä»‹ç»ã€‚">
  

  <!--Author-->
  
  <meta name="author" content="kirk">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="Unix Domain Socket">
  
  <!--Open Graph Description-->
  
      <meta property="og:description" content="å¹³å¸¸å·¥ä½œä¸­ï¼Œå¤§å®¶æˆ–å¤šæˆ–å°‘éƒ½å¬è¿‡æˆ–è€…ä½¿ç”¨è¿‡ Unix Domain Socket, ä½†å¯èƒ½æ²¡æœ‰ç³»ç»Ÿçš„æ€»ç»“æ¢³ç†è¿‡ï¼Œæ¯”å¦‚ä¸ TCP/UDP Socket
å·®åˆ«åœ¨å“ªé‡Œï¼Œé™¤äº†æ™®é€šçš„æ•°æ®ä¼ é€’è¿˜æœ‰å“ªäº›ç©æ³•ï¼Œèƒ½å¦åˆ©ç”¨ tcpdump æŠ“å–æµé‡å‘¢? è¯¥æ–‡ç« ä¸»è¦ä»æ˜¯ä»€ä¹ˆã€æ€ä¹ˆç”¨ã€æ€§èƒ½å¦‚ä½•å’ŒæŠ“åŒ…æ’éšœç­‰è§’åº¦è¿›è¡Œä»‹ç»ã€‚">
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="coding &amp; life">
  <!--Type page-->
  
      <meta property="og:type" content="article">
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>Unix Domain Socket - coding &amp; life</title>


  <link rel="shortcut icon" href="https://hexo.io/icon/favicon-96x96.png">

  <!-- Custom CSS/Sass -->
  
<link rel="stylesheet" href="/css/style.css">


  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

<meta name="generator" content="Hexo 4.2.0"></head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="https://hexo.io/logo.svg" alt="coding & life" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  home
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  archive
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            Unix Domain Socket
            
          </h1>
          <p class="posted-on">
          2020-09-05
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/socket/" rel="tag">
                  socket
                </a>
              
                <a href="/tags/network/" rel="tag">
                  network
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content ">
          <p>å¹³å¸¸å·¥ä½œä¸­ï¼Œå¤§å®¶æˆ–å¤šæˆ–å°‘éƒ½å¬è¿‡æˆ–è€…ä½¿ç”¨è¿‡ Unix Domain Socket, ä½†å¯èƒ½æ²¡æœ‰ç³»ç»Ÿçš„æ€»ç»“æ¢³ç†è¿‡ï¼Œæ¯”å¦‚ä¸ TCP/UDP Socket å·®åˆ«åœ¨å“ªé‡Œï¼Œé™¤äº†æ™®é€šçš„æ•°æ®ä¼ é€’è¿˜æœ‰å“ªäº›ç©æ³•ï¼Œèƒ½å¦åˆ©ç”¨ tcpdump æŠ“å–æµé‡å‘¢? è¯¥æ–‡ç« ä¸»è¦ä»æ˜¯ä»€ä¹ˆã€æ€ä¹ˆç”¨ã€æ€§èƒ½å¦‚ä½•å’ŒæŠ“åŒ…æ’éšœç­‰è§’åº¦è¿›è¡Œä»‹ç»ã€‚</p>
<a id="more"></a>
<h2 id="æ˜¯ä»€ä¹ˆ"><a href="#æ˜¯ä»€ä¹ˆ" class="headerlink" title="æ˜¯ä»€ä¹ˆ"></a>æ˜¯ä»€ä¹ˆ</h2><p>Unix Domain Socket ä¹Ÿå«åš IPC Socketï¼Œä¸å…¶ä»– IPC çš„æœºåˆ¶ Signalã€Pipeã€FIFOã€Message Queueã€Semaphore å’Œ Shared Memory ç±»ä¼¼ï¼Œéƒ½å¯ä»¥ç”¨äºåŒä¸€å°æœºå™¨ä¸Šä¸åŒè¿›ç¨‹é—´çš„æ•°æ®ä¼ è¾“ã€‚</p>
<p>æ¥å£ä¸Šä¸æˆ‘ä»¬å¹³å¸¸æ¥è§¦åˆ°çš„ Internet Socket åŸºæœ¬ç›¸åŒï¼Œç”¨æˆ·å¦‚æœæƒ³ä» TCP/UDP Socket åˆ‡æ¢åˆ° Unix Domian Socketï¼Œä»£ç å‡ ä¹ä¸ç”¨åšå˜æ›´ã€‚ä¸è¿‡ï¼Œä¸åŒçš„æ˜¯å…¶åº•å±‚å®ç°ä¸ä¾èµ–ä»»ä½• Network Protocolï¼Œå‘é€æ•°æ®æ—¶å‘é€æ–¹ç›´æ¥å°†æ•°æ®å†™åˆ°æ¥æ”¶æ–¹çš„ Socket Buffer, è€Œä¸ä¼šæ¶‰åŠåˆ°ä»»ä½• TCP/IP å¤´éƒ¨æ·»åŠ ã€æ ¡éªŒå’Œè®¡ç®—ã€Packet åˆ†æ®µã€Packet ç¡®è®¤ã€çª—å£å˜åŒ–ä»¥åŠè·¯ç”±é€‰æ‹©ç­‰æ“ä½œï¼Œç†è®ºä¸Šå¼€é”€æ›´å°ï¼Œæœ‰ç€æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>å¦å¤–ï¼ŒUnix Domain Socket ä¸ä½¿ç”¨ Internet Socket çš„ ip:port ä½œä¸ºåœ°å€ï¼Œè€Œæ˜¯ç”¨æ–‡ä»¶ç³»ç»Ÿä½œä¸ºåœ°å€å‘½åç©ºé—´ï¼Œæ¯”å¦‚ /var/run/docker.sock æ˜¯ redis-server ç›‘å¬çš„åœ°å€ï¼Œredis-cli å¯ä»¥æŒ‡å®šè¯¥åœ°å€ä¸ server å»ºç«‹è¿æ¥ã€‚</p>
<h2 id="å¦‚ä½•ç”¨"><a href="#å¦‚ä½•ç”¨" class="headerlink" title="å¦‚ä½•ç”¨"></a>å¦‚ä½•ç”¨</h2><h3 id="æ™®é€šæ”¶å‘"><a href="#æ™®é€šæ”¶å‘" class="headerlink" title="æ™®é€šæ”¶å‘"></a>æ™®é€šæ”¶å‘</h3><p>ä½¿ç”¨æ–¹å¼ä¸Šä¸å¹³å¸¸æ¥è§¦çš„ TCP/UDP Socket åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢æ˜¯ä¸€äº›å…·ä½“çš„ä¾‹å­:</p>
<h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><script src="//gist.github.com/kirk91/7569d02256566b0179963a35a63f92eb.js"></script>
<p>åœ¨ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ä¸Šé¢çš„ç¨‹åº:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run http_unix.go</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸Šç”¨ curl è¿›è¡Œæµ‹è¯•:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># query over the unix socket</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl --unix-socket /tmp/http-unix.sock http://unix</span></span><br><span class="line">Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl --unix-socket /tmp/http-unix.sock http://unix/path1</span></span><br><span class="line">Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl --unix-socket /tmp/http-unix.sock http://unix/path2</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><script src="//gist.github.com/kirk91/a6c8f6d07c754980b69ffc42127812a2.js"></script>
<p>åœ¨ä¸€ä¸ªç»ˆç«¯ä¸Šå¯åŠ¨ä¸Šé¢çš„ç¨‹åº:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run tcp_unix.go</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸Šä½¿ç”¨ netcat è¿›è¡Œæµ‹è¯•:</p>
<blockquote>
<p>netcat æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯ netcat-traditional å’Œ netcat-openbsdï¼Œtraditional ç‰ˆæœ¬ä¸æ”¯æŒ Unix Domain Socket(-U)ï¼Œæµ‹è¯•æ—¶è¦é¦–å…ˆç¡®è®¤è‡ªå·±å®‰è£…çš„æ˜¯ openbsd é‡å†™çš„ã€‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># connect to the socket</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nc -U /tmp/tcp-unix.sock</span></span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">hi</span><br><span class="line">hi</span><br><span class="line">bla bla bla</span><br><span class="line">bla bla bla</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>è®¤çœŸæŸ¥çœ‹ä¸Šé¢çš„ä¸¤æ®µä»£ç ï¼Œä¼šå‘ç°æ¯æ¬¡åœ¨æ‰§è¡Œ <code>net.Listen</code> å‰éƒ½ä¼šå…ˆæ‰§è¡Œ <code>os.Remove(udsPath)</code> æŠŠ socket æ–‡ä»¶åˆ é™¤æ‰ï¼Œåˆæ¬¡çœ‹åˆ°çš„è¯åº”è¯¥ä¼šæ„Ÿåˆ°éå¸¸å¥‡æ€ªï¼Œä¼šå¥½å¥‡ä¸ºå•¥è¦è¿™ä¹ˆç©ï¼Œæ˜¯ä¸æ˜¯å†™é”™äº†? </p>
<p>å…¶å®ä¸æ˜¯å†™é”™äº†ï¼Œè¿™ä¹ˆå†™æ˜¯æœ‰æ„ä¸ºä¹‹ï¼ŒåŸå› æ˜¯ Unix Socket ä¸åƒ Internet Socket, è¿›ç¨‹é€€å‡º(åŒ…æ‹¬ Crash)æ—¶æ“ä½œç³»ç»Ÿä¸ä¼šè‡ªåŠ¨æ¸…ç†æ‰åˆ›å»ºçš„ Socket æ–‡ä»¶ï¼Œä¸ºäº†ä¿è¯æœ¬è¿›ç¨‹èƒ½å¤ŸæˆåŠŸç›‘å¬ï¼Œå¿…é¡»ç¡®ä¿å…ˆå‰åˆ›å»ºçš„ Socket æ–‡ä»¶è¢«åˆ é™¤æ‰ï¼Œå¦åˆ™ä¼šä¸€ç›´æŠ¥ <code>bind: address already in use</code> çš„é”™è¯¯ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜å¯èƒ½ä¼šæœ‰æƒé™çš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ Linux å½“å‰çš„å®ç°ä¸­ï¼Œè¦æ±‚ Socket çš„åˆ›å»ºè€…éœ€è¦æ‹¥æœ‰è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ write å’Œ search(execute) æƒé™ï¼Œè¿æ¥åˆ° Socket çš„ä¸€æ–¹éœ€è¦æœ‰è¯¥æ–‡ä»¶çš„ write æƒé™ï¼Œå¦åˆ™ä¼šæŠ›å‡º Permission denied çš„é”™è¯¯ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä½œä¸ºåœ°å€å‘½åç©ºé—´çš„è¯ï¼Œéƒ½éœ€è¦å¤„ç†è¿™ä¸¤ç§æƒ…å†µï¼Œä¸ç„¶ç¨‹åºä¼šæŠ›å‡ºé”™è¯¯æ— æ³•è¿è¡Œã€‚ä½†æ˜¯ï¼Œåœ¨ Linux ä¸Šæœ‰ç¬¬äºŒç§é€‰æ‹©ï¼Œå¯ä»¥ä½¿ç”¨ Abstract Socket Namspaceã€‚å…·ä½“æ¥è¯´ï¼ŒLinux é¢å¤–å¼€å‘äº†ä¸€ä¸ªå«åš Abstract Namespace çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Socket è€Œä¸ç”¨ç»‘å®šæ–‡ä»¶ï¼Œç”šè‡³åœ¨è¿›ç¨‹é€€å‡º(æ— å¼•ç”¨)æ—¶ä¼šè¢«è‡ªåŠ¨æ¸…ç†æ‰ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­:</p>
<script src="//gist.github.com/kirk91/688cf5a2b8fb8dcc879f420552ff827f.js"></script>
<p>å¼€å¯ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä¸Šé¢ç¨‹åº:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run tcp_abstract_unix.go</span></span><br></pre></td></tr></table></figure>
<p>å¦å¼€ä¸€ä¸ªç»ˆç«¯ç”¨ socat è¿›è¡Œæµ‹è¯•:</p>
<blockquote>
<ul>
<li>netcat ä¸æ”¯æŒ abstract socket</li>
<li>socat ä»‹ç» https://medium.com/@copyconstruct/socat-29453e9fc8a6</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># show tcp-unix.sock</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ss -xlp | grep tcp-unix.sock</span></span><br><span class="line">u_str LISTEN 0 16384  @tcp-unix.sock 136766257 * 0 users:(("tcp_abstract_un",pid=1878602,fd=3))</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># connect to the abstract socket</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> socat - ABSTRACT-CONNECT:tcp-unix.sock</span></span><br><span class="line">hello</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">world</span><br><span class="line">ğŸ˜Š</span><br><span class="line">ğŸ˜Š</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<h3 id="FD-ä¼ é€’"><a href="#FD-ä¼ é€’" class="headerlink" title="FD ä¼ é€’"></a>FD ä¼ é€’</h3><p>Unix Socket é™¤äº†èƒ½å¤Ÿä¼ è¾“æ™®é€šçš„æ•°æ®å¤–ï¼Œè¿˜èƒ½å¤Ÿåœ¨å®Œå…¨ä¸ç›¸å…³(éçˆ¶å­)çš„è¿›ç¨‹é—´ä¼ é€’ FD, å¾ˆå¤šå¼€æºçš„é¡¹ç›® HAProxyã€Nginx å’Œ Envoy éƒ½æœ‰ç”¨åˆ°è¯¥ç‰¹æ€§ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå°† HTTP Listener é€šè¿‡ Unix Socket ä»ä¸€ä¸ªè¿›ç¨‹ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„ä¾‹å­:</p>
<ul>
<li>fd_send.go: å‘é€æ–¹</li>
<li>fd_receive.go: æ¥å—æ–¹</li>
</ul>
<script src="//gist.github.com/kirk91/ec25703848172e8f56f671e0e1c73751.js"></script>
<p>å¼€å¯ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«å¯åŠ¨ fd_send.go å’Œ fd_receive.go ç¨‹åº:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run fd_send.go</span></span><br><span class="line">2020/08/10 19:02:19 Server is listening on 127.0.0.1:8080 ...</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run fd_receive.go</span></span><br><span class="line">2020/08/10 19:17:58 Wait receiving listener ...</span><br></pre></td></tr></table></figure>
<p>å¦å¤–å¼€å¯ä¸€ä¸ªç»ˆç«¯è¿›è¡Œæµ‹è¯•:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># query, receive the response from server1</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost:8080</span></span><br><span class="line">[server1] Hello, world!</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># trigger passing file descriptor</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost:8080/passfd</span></span><br><span class="line">Success</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># query again, receive the response from server2</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost:8080</span></span><br><span class="line">[server2] Hello, world!</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/wqCSh9n.png" alt=""></p>
<blockquote>
<ol>
<li>Unix Socket ä¸æ”¯æŒ SO_REUSEPORT, å¤šä¸ªè¿›ç¨‹æ²¡æ³•ç›´æ¥ç›‘å¬åŒä¸€ Socket</li>
<li>FD ä¼ é€’ï¼Œå¹¶ä¸æ˜¯å°† FD çš„å€¼ä¼ é€’ç»™å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯ä¼ é€’çš„å†…æ ¸åŒä¸€ File ç»“æ„çš„å¼•ç”¨ï¼Œä¸¤è€…éƒ½æŒ‡å‘å†…æ ¸ Open File Table çš„åŒä¸€ä¸ª File, ä¸¤ä¸ª FD çš„å€¼ä¸è¦æ±‚ä¸€æ ·ï¼Œå¹¶ä¸”åœ¨ç°å®ä¸­å¤§æ¦‚ç‡æ˜¯ä¸åŒçš„</li>
</ol>
</blockquote>
<p>ä»æµ‹è¯•ç»“æœçœ‹ï¼ŒHTTP Listener çš„ FD æˆåŠŸçš„ä¼ é€’åˆ°äº†æ¥å—æ–¹ï¼Œå¹¶ä¸”æ¥å—æ–¹èƒ½å¤Ÿæ­£å¸¸å¤„ç†ç”¨æˆ·è¯·æ±‚ã€‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿé€šè¿‡ Unix Socket èƒ½å¤Ÿä¼ é€’ FDï¼Œæ˜¯å› ä¸ºæ•°æ®å‘é€è°ƒç”¨äº† sendmg æ¥å£ï¼Œå…¶å‚æ•° msg æ”¯æŒæºå¸¦è¾…åŠ©æ•°æ®ï¼Œä¸‹é¢æ˜¯ä»–ä»¬çš„ç­¾å:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> sendmsg(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct msghdr *msg, <span class="keyword">int</span> flags);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>         *msg_name;       <span class="comment">/* optional address */</span></span><br><span class="line">    <span class="keyword">socklen_t</span>     msg_namelen;    <span class="comment">/* size of address */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>        <span class="comment">/* scatter/gather array */</span></span><br><span class="line">    <span class="keyword">size_t</span>        msg_iovlen;     <span class="comment">/* # elements in msg_iov */</span></span><br><span class="line">    <span class="keyword">void</span>         *msg_control;    <span class="comment">/* ancillary data, see below */</span></span><br><span class="line">    <span class="keyword">size_t</span>        msg_controllen; <span class="comment">/* ancillary data buffer len */</span></span><br><span class="line">    <span class="keyword">int</span>           msg_flags;      <span class="comment">/* flags on received message */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ msg_control å’Œ msg_controllen æ˜¯ç”¨æ¥ä¼ é€’è¾…åŠ©æ•°æ®çš„ï¼Œmsg_control å¯¹åº”çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> cmsg_len;    <span class="comment">/* data byte count, including header */</span></span><br><span class="line">    <span class="keyword">int</span>       cmsg_level;  <span class="comment">/* originating protocol */</span></span><br><span class="line">    <span class="keyword">int</span>       cmsg_type;   <span class="comment">/* protocol-specific type */</span></span><br><span class="line">    <span class="comment">/* followed by */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> cmsg_data[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶å„å‚æ•°çš„å«ä¹‰å’Œç”¨æ³•å¯ä»¥å‚è€ƒ https://man7.org/linux/man-pages/man3/cmsg.3.html</p>
<p>æœ€åï¼Œé™¤äº†ä¼ é€’ FD å¤–ï¼Œåœ¨ Linux å½“å‰å®ç°ä¸­è¿˜æ”¯æŒä¼ é€’ credentials å’Œ selinux context, æœåŠ¡ç«¯å¯ä»¥ç”¨æ¥éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½ï¼Œç”±äºæ¶‰åŠåˆ°çš„ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸å†è¯¦ç»†æè¿°ï¼Œå…·ä½“ç”¨æ³•å‚è§ https://www.man7.org/linux/man-pages/man7/unix.7.html</p>
<h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><p>å‰é¢æåˆ° Unix Domain Socket å‘é€æ•°æ®çš„æ—¶å€™ç›´æ¥å°†æ•°æ®å†™åˆ°æ¥æ”¶æ–¹çš„ Socket Bufferï¼Œä¸ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œç†è®ºä¸Šå¼€é”€æ›´å°ï¼Œä¸è¿‡ç¼ºå°‘å®é™…çš„æ•°æ®æŒ‡æ ‡ï¼Œä¸‹é¢ä»¥ redis ä¸ºä¾‹å­ï¼Œæµ‹è¯•ä¸‹åœ¨åŒæ ·ç¯å¢ƒä¸‹ Unix Domain Socket å’Œ TCP/IP Loopback çš„è¡¨ç°ã€‚</p>
<h3 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>Redis Version: 4.0.9
Linux Kernel: 4.15.0-112-generic
CPU: 1 x Intel(R) Core(TM) i7-8557U CPU @ 1.70GHz</p>
<h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><p><strong>TCP/IP Loopback</strong>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redis-benchmark -t ping,get,<span class="built_in">set</span> -q -d 256 -n 100000</span></span><br><span class="line">PING_INLINE: 60060.06 requests per second</span><br><span class="line">PING_BULK: 56211.35 requests per second</span><br><span class="line">SET: 54884.74 requests per second</span><br><span class="line">GET: 54141.85 requests per second</span><br></pre></td></tr></table></figure></p>
<p><strong>Unix Domain Socket</strong>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redis-benchmark -t ping,get,<span class="built_in">set</span> -q -s /var/run/redis/redis-server.sock -d 256 -n 100000</span></span><br><span class="line">PING_INLINE: 82169.27 requests per second</span><br><span class="line">PING_BULK: 82712.98 requests per second</span><br><span class="line">SET: 85984.52 requests per second</span><br><span class="line">GET: 82101.80 requests per second</span><br></pre></td></tr></table></figure></p>
<p>ä»æµ‹è¯•ç»“æœä¸Šçœ‹ï¼ŒUnix Domain Socket çš„ååé‡æ˜¯ TCP/IP Loopback çš„ 1.5 å€ï¼Œæå‡äº†çº¦ 50%ã€‚</p>
<h2 id="æ’éšœ"><a href="#æ’éšœ" class="headerlink" title="æ’éšœ"></a>æ’éšœ</h2><p>ç½‘ç»œç›¸å…³çš„ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šå‡ºç°é¢„æœŸä¹‹å¤–çš„æƒ…å†µï¼Œä¸ºäº†ææ¸…æ¥šåŸå› å¤§å¤šæ—¶å€™æˆ‘ä»¬ä¼šç”¨ tcpdump æŠ“åŒ…å¹¶è¿›è¡Œåˆ†æã€‚ç„¶è€Œ Unix Socket åº•å±‚å®ç°ä¸ä¾èµ–ä»»ä½• Network Protocolï¼Œå…¶æ•°æ®ä¸ç»è¿‡ä»»ä½•ç½‘ç»œåè®®æ ˆï¼Œtcpdump å’Œ tshark å®Œå…¨æ²¡æ³•å‘æŒ¥å…¶ç”¨å¤„ã€‚</p>
<p>å¹¶ä¸”ï¼Œè™½ç„¶ Unix Socket è¢«å¾ˆå¤šåŸºç¡€ç»„ä»¶ MySQLã€Redisã€Docker ç­‰æ”¯æŒï¼Œä½†ç¤¾åŒºå´æ²¡æœ‰ä¸€ä¸ªç±»ä¼¼äº tcpdump çš„æ ‡å‡†æŠ“åŒ…å·¥å…·ï¼Œå¯¹å¼€å‘è€…ä¸æ˜¯å¾ˆå‹å¥½ï¼Œå‡ºé”™æ’éšœæˆæœ¬ä¹Ÿæ¯”è¾ƒé«˜ã€‚ä¸è¿‡ï¼Œæ²¡æœ‰æ ‡å‡†çš„å·¥å…·ä¸ä»£è¡¨ä¸èƒ½åˆ†ææµé‡ï¼Œä¸€å®šè¦åšçš„è¯è¿˜æ˜¯æœ‰ä¸€äº›æŠ˜è¡·çš„åŠæ³•çš„ï¼Œä¸‹é¢ä»¥ docker ä¸ºä¾‹å­ä»‹ç»ä¸‹ç¤¾åŒºå¸¸è§çš„æ–¹æ¡ˆ:</p>
<blockquote>
<p>docker æ˜¯ client-server æ¶æ„ï¼Œä¸¤è€…é€šä¿¡é»˜è®¤é‡‡ç”¨ unix domain socket</p>
</blockquote>
<h3 id="Man-in-the-middle"><a href="#Man-in-the-middle" class="headerlink" title="Man in the middle"></a>Man in the middle</h3><p>æ ¸å¿ƒæ€æƒ³æ˜¯åˆ›å»ºä¸€ä¸ªä¸­é—´çš„ TCP Socket, ç„¶ååœ¨ TCP Socket ä¸Šå€ŸåŠ© tcpdump æŠ“åŒ…ï¼Œå…·ä½“ç©æ³•å¦‚ä¸‹:</p>
<p>åœ¨ä¸€ä¸ªç»ˆç«¯ä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># 1. è·å– docker ç›‘å¬çš„ socket æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsof -p $(pgrep dockerd) | grep docker.sock</span></span><br><span class="line">dockerd 16087 root 6u unix 0xffff9cec3aee4000 0t0 45084 /var/run/docker.sock type=STREAM</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># 2. é‡å‘½ååŸæ¥çš„ socket æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mv /var/run/docker.sock&#123;,.orig&#125;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># 3. åˆ›å»ºä¸­é—´çš„ tcp socket å¹¶æ‹·è´æµé‡</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo socat TCP-LISTEN:8080,reuseaddr,fork UNIX-CONNECT:/var/run/docker.sock.orig &amp;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># 4. åˆ›å»ºåŸæ¥çš„ socket æ–‡ä»¶å¹¶æ‹·è´æµé‡</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo socat UNIX-LISTEN:/var/run/docker.sock,fork TCP-CONNECT:127.0.0.1:8080 &amp;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># 5. ä½¿ç”¨ tcpdump åœ¨ä¸­é—´çš„ tcp socket ä¸ŠæŠ“åŒ…</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tcpdump -i lo tcp port 8080 -XX</span></span><br></pre></td></tr></table></figure></p>
<p>å¦å¤–å¼€å¯ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ docker images è¿›è¡Œæµ‹è¯•ï¼Œä¸‹é¢æ˜¯ tcpdump æŠ“åŒ…çš„éƒ¨åˆ†ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸæŠ“å–åˆ°äº†é€šä¿¡è¿‡ç¨‹ä¸­çš„ HTTP è¯·æ±‚ã€‚</p>
<p><img src="https://i.imgur.com/QHhQzmI.png" alt=""></p>
<p>è¯¥æ–¹æ¡ˆèƒ½å¤Ÿåˆ©ç”¨ç°æˆçš„ tcpdump å·¥å…·ï¼Œæ¯”è¾ƒå‹å¥½ï¼Œä½†ç¼ºç‚¹æ˜¯éœ€è¦é‡å¯ client é‡å»ºè¿æ¥ï¼Œå¯¹äºæ²¡æ³•é‡å¯çš„å°±ç©ä¸è½¬äº†ã€‚</p>
<h3 id="Strace"><a href="#Strace" class="headerlink" title="Strace"></a>Strace</h3><p>æ ¸å¿ƒæ€æƒ³ trace æ•°æ®æ”¶å‘çš„ read å’Œ write ç³»ç»Ÿè°ƒç”¨ï¼Œè·å– read/write çš„å‚æ•°, å…·ä½“ç©æ³•å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="comment"># å±•ç¤º docker images æ¶‰åŠåˆ°çš„ write è°ƒç”¨</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> strace -e trace=write -e write=3 -v -s 1024 docker images 1&gt;/dev/null</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/QukkDvw.png" alt=""></p>
<p>è¯¥æ–¹æ¡ˆæ— éœ€é‡å»ºè¿æ¥ï¼Œèƒ½å¤Ÿåœ¨å·²æœ‰çš„è¿æ¥ä¸ŠæŠ“å–æµé‡ï¼Œä¸è¿‡ strace å¯¹ç¨‹åºçš„æ€§èƒ½æœ‰æ¯”è¾ƒå¤§çš„å½±å“ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„æ—¶å€™éœ€è¦é¢å¤–æ…é‡ã€‚</p>
<h3 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h3><blockquote>
<p>eBPF æ˜¯ Linux å†…æ ¸åœ¨ 3.18 ç‰ˆæœ¬ä»¥åå¼•å…¥äº†çš„ä¸€ç§æ‰©å±•çš„ BPF è™šæ‹Ÿæœºï¼Œå…è®¸ç”¨æˆ·åŠ¨æ€çš„è·å–ã€ä¿®æ”¹å†…æ ¸ä¸­çš„å…³é”®æ•°æ®å’Œæ‰§è¡Œé€»è¾‘ï¼Œå¹¶ä¸”æœ‰ç€éå¸¸ä¼˜ç§€çš„æ€§èƒ½ã€‚</p>
</blockquote>
<p>æ ¸å¿ƒæ€æƒ³ä¸ strace ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ trace æ¥åˆ†æè¯»å†™æµé‡ï¼Œä¸è¿‡ eBPF æœ‰ç€æ›´å°çš„å¼€é”€ï¼Œå¯¹åº”ç”¨ç¨‹åºæ€§èƒ½å½±å“è¾ƒå°ã€‚<a href="https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2019/march/ebpf-adventures-fiddling-with-the-linux-kernel-and-unix-domain-sockets/" target="_blank" rel="external nofollow noopener noreferrer">unixdump</a> å°±æ˜¯è¿™æ ·ä¸€ä¸ªåŸºäº eBPF å’Œ <a href="https://www.iovisor.org/technology/bcc" target="_blank" rel="external nofollow noopener noreferrer">bcc</a> å¼€å‘çš„å·¥å…·ï¼Œèƒ½å¤Ÿéå¸¸æ–¹ä¾¿åœ° dump ç³»ç»Ÿæ‰€æœ‰çš„ unix domain sockets æµé‡ï¼Œä¹Ÿæ”¯æŒè¿‡æ»¤æŸä¸€ä¸ª socketï¼Œä¸‹é¢æ˜¯å…·ä½“çš„ç©æ³•:</p>
<p>é¦–å…ˆå¼€å¯ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ unixdump ç¨‹åº</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo unixdump -s /var/run/docker.sock</span></span><br></pre></td></tr></table></figure>
<p>å¦å¤–å¼€å¯ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ docker iamges æ‰§è¡Œæµ‹è¯•ï¼Œä¸‹é¢æ˜¯ dump çš„ç»“æœ:</p>
<p><img src="https://i.imgur.com/THiUMKa.png" alt=""></p>
<p>è¯¥æ–¹æ¡ˆæ— éœ€é‡å»ºè¿æ¥ï¼Œå¯¹åº”ç”¨ç¨‹åºæ€§èƒ½å½±å“è¾ƒå°ï¼Œæ“ä½œæ–¹ä¾¿ï¼Œæœ‰æ¯”è¾ƒå¼ºçš„æ™®é€‚æ€§ï¼›ä¸è¿‡ç”±äºä¾èµ–äº† eBPFï¼Œå¯¹å†…æ ¸ç‰ˆæœ¬æœ‰ä¸€å®šçš„è¦æ±‚ã€‚</p>
<p>æ³¨: ä¸Šé¢çœç•¥äº† <a href="https://www.iovisor.org/technology/bcc" target="_blank" rel="external nofollow noopener noreferrer">bcc</a> å’Œ <a href="https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2019/march/ebpf-adventures-fiddling-with-the-linux-kernel-and-unix-domain-sockets/" target="_blank" rel="external nofollow noopener noreferrer">unixdump</a> çš„å®‰è£…æ­¥éª¤ï¼Œåœ¨å®é™…æµ‹è¯•çš„æ—¶å€™éœ€è¦é¦–å…ˆè¿›è¡Œå®‰è£…ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Unix Domain Socket æä¾›äº†ä¸€ç§å•æœºä¸åŒè¿›é—´ç¨‹é€šä¿¡çš„æ–¹æ¡ˆï¼Œæ¥å£ä¸Šä¸ Internet Socket ç±»ä¼¼ï¼ŒåŠŸèƒ½ä¸Šé™¤äº†æ”¯æŒå‘é€æ™®é€šæ•°æ®å¤–ï¼Œè¿˜èƒ½åœ¨è¿›ç¨‹é—´ä¼ é€’ FDã€Credentials å’Œ SELinux Security Contextä¿¡æ¯ï¼Œæ€§èƒ½ä¸Šç›¸å¯¹äº TCP/IP æœ¬åœ°å›ç¯ç½‘ç»œæœ‰ 50% å·¦å³çš„æ€§èƒ½æå‡ï¼Œæ’éšœä¸Šç¤¾åŒºæ²¡æœ‰ç±»ä¼¼äº tcpdump çš„æˆç†Ÿå·¥å…·ï¼Œæµé‡åˆ†æå’Œæ’éšœçš„æˆæœ¬ä¼šæ¯”è¾ƒé«˜ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://lists.freebsd.org/pipermail/freebsd-performance/2005-February/001143.html" target="_blank" rel="external nofollow noopener noreferrer">unix domain sockets vs. internet sockets</a></li>
<li><a href="http://laforge.gnumonks.org/blog/20180330-udtrace/" target="_blank" rel="external nofollow noopener noreferrer">udtrace - Unix domain socket tracing</a></li>
<li><a href="https://archive.fosdem.org/2020/schedule/event/debugging_strace_perfotmance/attachments/slides/4046/export/events/attachments/debugging_strace_perfotmance/slides/4046/fosdem_2020_slides_strace_fight_for_performance.pdf" target="_blank" rel="external nofollow noopener noreferrer">strace fight for performance</a></li>
<li><a href="https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2019/march/ebpf-adventures-fiddling-with-the-linux-kernel-and-unix-domain-sockets/" target="_blank" rel="external nofollow noopener noreferrer">ebpf adventures fiddling with the linux kernel and unix domain sockets</a></li>
</ul>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
  <div id="disqus_thread">
    <script type="text/javascript">
    var disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = 'post-unix-domain-socket';
          this.page.title = 'Unix Domain Socket';
      };
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
  </div>
  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
        <div class="nav-previous">
          <a href="/posts/70bdc8a2/" rel="prev"><span class="meta-arraw meta-arraw-left"></span> Older Posts</a>
        </div>
      
      
        <div class="nav-next">
          <a href="/posts/18ea64ae/" rel="prev">Newer Posts <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">å…³äºæœ¬ç«™</h1>
        <div class="custom-widget-content">
          
          Keep learning forever
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Contact</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/kirk91" class="icon icon-github" target="_blank" rel="external nofollow noopener noreferrer">github</a>
            
              <a href="mailto:kirk91.han@gmail.com" class="icon icon-mail" target="_blank" rel="external nofollow noopener noreferrer">mail</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Search</h1>
        <div class="widget-text">
          <form onsubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>coding & life &copy; 2022</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank" rel="external nofollow noopener noreferrer">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->

<script src="/js/app.js"></script>


<script>
  var disqus_shortname = 'kirk91';

  
  var disqus_url = 'https://kirk91.github.io/posts/e850c11/';
  

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<!-- google_analytics start -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89547051-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- google_analytics end -->



</body>

</html>
